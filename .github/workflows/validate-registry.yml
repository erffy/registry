name: Validate Registry Entries

on:
  pull_request_target:
    paths:
      - 'repositories/**/*.json'
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
    paths:
      - 'repositories/**/*.json'

# Required for pull_request_target to have write access to PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate JSON Entries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR head (pull_request_target)
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch (PR only)
        if: github.event_name == 'pull_request_target'
        run: |
          git remote add upstream https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git || true
          git fetch upstream ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'repositories/**/*.json' 2>/dev/null | tr '\n' ' ' || echo "")
          else
            # For PR events, compare with base branch
            CHANGED_FILES=$(git diff --name-only upstream/${{ github.event.pull_request.base.ref }}...HEAD -- 'repositories/**/*.json' | tr '\n' ' ')
          fi
          
          echo "all_changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Changed files: $CHANGED_FILES"

      - name: Validate JSON syntax
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ” Validating JSON syntax..."
          
          ERRORS=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            # Skip if file was deleted
            if [ ! -f "$file" ]; then
              echo "â„¹ï¸ Skipping deleted file: $file"
              continue
            fi
            
            echo "Checking: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON syntax in: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "âœ… Valid JSON syntax"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS file(s) with invalid JSON syntax"
            exit 1
          fi

      - name: Validate schema and check GitHub repos
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "ðŸ” Validating schema and checking GitHub repositories..."
          
          ERRORS=0
          WARNINGS=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“„ Validating: $file"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check if file was deleted
            if [ ! -f "$file" ]; then
              echo "â„¹ï¸ File was deleted, skipping validation"
              continue
            fi
            
            # Extract fields
            NAME=$(jq -r '.name // empty' "$file")
            OWNER=$(jq -r '.owner // empty' "$file")
            REPO=$(jq -r '.repo // empty' "$file")
            DESCRIPTION=$(jq -r '.description // empty' "$file")
            LICENSE=$(jq -r '.license // empty' "$file")
            CATEGORY=$(jq -r '.category // empty' "$file")
            HOMEPAGE=$(jq -r '.homepage // empty' "$file")
            
            # Validate required fields
            echo ""
            echo "ðŸ“‹ Required fields:"
            
            if [ -z "$NAME" ]; then
              echo "  âŒ name: Missing (required)"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ… name: $NAME"
            fi
            
            if [ -z "$OWNER" ]; then
              echo "  âŒ owner: Missing (required)"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ… owner: $OWNER"
            fi
            
            if [ -z "$REPO" ]; then
              echo "  âŒ repo: Missing (required)"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ… repo: $REPO"
            fi
            
            if [ -z "$DESCRIPTION" ]; then
              echo "  âŒ description: Missing (required)"
              ERRORS=$((ERRORS + 1))
            else
              DESC_LEN=${#DESCRIPTION}
              if [ $DESC_LEN -gt 200 ]; then
                echo "  âš ï¸ description: Too long ($DESC_LEN chars, max 200)"
                WARNINGS=$((WARNINGS + 1))
              else
                echo "  âœ… description: $DESCRIPTION"
              fi
            fi
            
            # Validate optional fields
            echo ""
            echo "ðŸ“‹ Optional fields:"
            
            if [ -z "$LICENSE" ]; then
              echo "  â„¹ï¸ license: Not specified (will be fetched from GitHub)"
            else
              echo "  âœ… license: $LICENSE"
            fi
            
            if [ -z "$CATEGORY" ]; then
              echo "  â„¹ï¸ category: Not specified"
            else
              # Validate category format (lowercase, hyphenated)
              if [[ ! "$CATEGORY" =~ ^[a-z0-9-]+$ ]]; then
                echo "  âš ï¸ category: Invalid format '$CATEGORY' (use lowercase with hyphens)"
                WARNINGS=$((WARNINGS + 1))
              else
                echo "  âœ… category: $CATEGORY"
              fi
            fi
            
            if [ -z "$HOMEPAGE" ]; then
              echo "  â„¹ï¸ homepage: Not specified"
            else
              echo "  âœ… homepage: $HOMEPAGE"
            fi
            
            # Check GitHub repository exists
            if [ -n "$OWNER" ] && [ -n "$REPO" ]; then
              echo ""
              echo "ðŸ”— Checking GitHub repository: $OWNER/$REPO"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$OWNER/$REPO")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "  âœ… Repository exists and is accessible"
                
                # Check if repo has build.zig or build.zig.zon
                ZIG_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/$OWNER/$REPO/contents/build.zig")
                
                ZON_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/$OWNER/$REPO/contents/build.zig.zon")
                
                if [ "$ZIG_CHECK" = "200" ] || [ "$ZON_CHECK" = "200" ]; then
                  echo "  âœ… Zig project files found"
                else
                  echo "  âš ï¸ No build.zig or build.zig.zon found (may not be a Zig project)"
                  WARNINGS=$((WARNINGS + 1))
                fi
                
                # Extract repo info
                REPO_STARS=$(echo "$BODY" | jq -r '.stargazers_count // 0')
                REPO_ARCHIVED=$(echo "$BODY" | jq -r '.archived // false')
                REPO_PUSHED=$(echo "$BODY" | jq -r '.pushed_at // empty')
                
                echo "  â­ Stars: $REPO_STARS"
                
                if [ "$REPO_ARCHIVED" = "true" ]; then
                  echo "  âš ï¸ Repository is archived"
                  WARNINGS=$((WARNINGS + 1))
                fi
                
                # Check if updated within last year
                if [ -n "$REPO_PUSHED" ]; then
                  PUSHED_TIMESTAMP=$(date -d "$REPO_PUSHED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$REPO_PUSHED" +%s 2>/dev/null || echo "0")
                  NOW_TIMESTAMP=$(date +%s)
                  YEAR_AGO=$((NOW_TIMESTAMP - 31536000))
                  
                  if [ "$PUSHED_TIMESTAMP" -lt "$YEAR_AGO" ] 2>/dev/null; then
                    echo "  âš ï¸ Repository hasn't been updated in over a year"
                    WARNINGS=$((WARNINGS + 1))
                  fi
                fi
              elif [ "$HTTP_CODE" = "404" ]; then
                echo "  âŒ Repository not found"
                ERRORS=$((ERRORS + 1))
              elif [ "$HTTP_CODE" = "403" ]; then
                echo "  âš ï¸ Rate limited or access denied, skipping repo check"
                WARNINGS=$((WARNINGS + 1))
              else
                echo "  âŒ Failed to access repository (HTTP $HTTP_CODE)"
                ERRORS=$((ERRORS + 1))
              fi
            fi
            
            echo ""
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Validation Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âŒ Errors: $ERRORS"
          echo "  âš ï¸ Warnings: $WARNINGS"
          echo ""
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Validation failed with $ERRORS error(s)"
            exit 1
          fi
          
          if [ $WARNINGS -gt 0 ]; then
            echo "::warning::Validation completed with $WARNINGS warning(s)"
          fi
          
          echo "âœ… Validation passed!"

  check-duplicates:
    name: Check for Duplicates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4

      - name: Checkout PR head (pull_request_target)
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check for duplicate repos
        run: |
          echo "ðŸ” Checking for duplicate repository entries..."
          
          DUPLICATES=0
          
          # Get all owner/repo combinations
          find repositories -name "*.json" -exec jq -r '"\(.owner)/\(.repo)"' {} \; 2>/dev/null | sort | uniq -d > /tmp/duplicates.txt
          
          if [ -s /tmp/duplicates.txt ]; then
            echo "âŒ Found duplicate repository entries:"
            cat /tmp/duplicates.txt
            DUPLICATES=1
          else
            echo "âœ… No duplicate repository entries found"
          fi
          
          # Check for duplicate names
          find repositories -name "*.json" -exec jq -r '.name' {} \; 2>/dev/null | sort | uniq -di > /tmp/name_duplicates.txt
          
          if [ -s /tmp/name_duplicates.txt ]; then
            echo ""
            echo "âš ï¸ Found entries with similar names (case-insensitive):"
            cat /tmp/name_duplicates.txt
          fi
          
          if [ $DUPLICATES -gt 0 ]; then
            exit 1
          fi

  lint-filenames:
    name: Lint Filenames
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR head (pull_request_target)
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch (PR only)
        if: github.event_name == 'pull_request_target'
        run: |
          git remote add upstream https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git || true
          git fetch upstream ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'repositories/**/*.json' 2>/dev/null | tr '\n' ' ' || echo "")
          else
            CHANGED_FILES=$(git diff --name-only upstream/${{ github.event.pull_request.base.ref }}...HEAD -- 'repositories/**/*.json' | tr '\n' ' ')
          fi
          
          echo "all_changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate filenames
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ” Validating filenames..."
          
          ERRORS=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            # Skip deleted files
            if [ ! -f "$file" ]; then
              continue
            fi
            
            FILENAME=$(basename "$file")
            
            # Check lowercase
            if [[ "$FILENAME" =~ [A-Z] ]]; then
              echo "âŒ Filename contains uppercase letters: $file"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Check no spaces
            if [[ "$FILENAME" =~ \  ]]; then
              echo "âŒ Filename contains spaces: $file"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Check valid characters (alphanumeric, hyphens, underscores)
            if [[ ! "$FILENAME" =~ ^[a-z0-9_-]+\.json$ ]]; then
              echo "âŒ Filename contains invalid characters: $file (use only lowercase, numbers, hyphens, underscores)"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS filename issue(s)"
            exit 1
          fi
          
          echo "âœ… All filenames are valid"

  summary:
    name: Create Summary and Comment
    runs-on: ubuntu-latest
    needs: [validate, check-duplicates, lint-filenames]
    if: always() && github.event_name == 'pull_request_target'
    # Note: permissions are inherited from top-level but can be more restrictive
    
    steps:
      - name: Create PR Comment
        uses: actions/github-script@v7
        with:
          # Use github.token for pull_request_target - it has write access to base repo
          github-token: ${{ github.token }}
          script: |
            const validateResult = '${{ needs.validate.result }}';
            const duplicateResult = '${{ needs.check-duplicates.result }}';
            const filenameResult = '${{ needs.lint-filenames.result }}';
            
            const allPassed = validateResult === 'success' && 
                              duplicateResult === 'success' && 
                              filenameResult === 'success';
            
            const statusEmoji = allPassed ? 'âœ…' : 'âŒ';
            const statusText = allPassed ? 'All checks passed!' : 'Some checks failed';
            
            const body = [
              `## ${statusEmoji} Registry Validation: ${statusText}`,
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| Schema Validation | ${validateResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |`,
              `| Duplicate Check | ${duplicateResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |`,
              `| Filename Lint | ${filenameResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |`,
              '',
              allPassed 
                ? 'ðŸŽ‰ Your submission looks good! A maintainer will review it shortly.'
                : 'âš ï¸ Please fix the issues above and push new changes.',
              '',
              '---',
              '*ðŸ¤– This is an automated message from the Zig Index validation bot.*'
            ].join('\n');
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.body?.includes('Registry Validation') &&
              c.body?.includes('automated message')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing validation comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new validation comment');
            }

      - name: Write Step Summary
        run: |
          echo "## ðŸ“‹ Registry Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate.result }}" = "success" ]; then
            echo "âœ… **Schema Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Schema Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.check-duplicates.result }}" = "success" ]; then
            echo "âœ… **Duplicate Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Duplicate Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint-filenames.result }}" = "success" ]; then
            echo "âœ… **Filename Lint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Filename Lint**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For guidelines on adding projects, see [CONTRIBUTING.md](../CONTRIBUTING.md)" >> $GITHUB_STEP_SUMMARY
