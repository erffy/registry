name: Validate Registry Entries

on:
  pull_request:
    paths:
      - 'repositories/**/*.json'
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
    paths:
      - 'repositories/**/*.json'

jobs:
  validate:
    name: Validate JSON Entries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            repositories/**/*.json

      - name: Validate JSON syntax
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ” Validating JSON syntax..."
          
          ERRORS=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON syntax in: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "âœ… Valid JSON syntax"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS file(s) with invalid JSON syntax"
            exit 1
          fi

      - name: Validate schema and check GitHub repos
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "ðŸ” Validating schema and checking GitHub repositories..."
          
          ERRORS=0
          WARNINGS=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“„ Validating: $file"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check if file was deleted
            if [ ! -f "$file" ]; then
              echo "ðŸ—‘ï¸ File was deleted - skipping validation"
              continue
            fi
            
            # Extract fields
            NAME=$(jq -r '.name // empty' "$file")
            OWNER=$(jq -r '.owner // empty' "$file")
            REPO=$(jq -r '.repo // empty' "$file")
            DESCRIPTION=$(jq -r '.description // empty' "$file")
            LICENSE=$(jq -r '.license // empty' "$file")
            CATEGORY=$(jq -r '.category // empty' "$file")
            HOMEPAGE=$(jq -r '.homepage // empty' "$file")
            
            # Validate required fields
            echo ""
            echo "ðŸ“‹ Required fields:"
            
            if [ -z "$NAME" ]; then
              echo "  âŒ name: MISSING (required)"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ… name: $NAME"
            fi
            
            if [ -z "$OWNER" ]; then
              echo "  âŒ owner: MISSING (required)"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ… owner: $OWNER"
            fi
            
            if [ -z "$REPO" ]; then
              echo "  âŒ repo: MISSING (required)"
              ERRORS=$((ERRORS + 1))
            else
              echo "  âœ… repo: $REPO"
            fi
            
            if [ -z "$DESCRIPTION" ]; then
              echo "  âŒ description: MISSING (required)"
              ERRORS=$((ERRORS + 1))
            else
              DESC_LEN=${#DESCRIPTION}
              if [ $DESC_LEN -gt 200 ]; then
                echo "  âš ï¸ description: Too long ($DESC_LEN chars, max 200)"
                WARNINGS=$((WARNINGS + 1))
              else
                echo "  âœ… description: $DESC_LEN chars"
              fi
            fi
            
            # Validate optional fields
            echo ""
            echo "ðŸ“‹ Optional fields:"
            
            if [ -z "$LICENSE" ]; then
              echo "  â„¹ï¸ license: Not specified (will be fetched from GitHub)"
            else
              echo "  âœ… license: $LICENSE"
            fi
            
            if [ -z "$CATEGORY" ]; then
              echo "  â„¹ï¸ category: Not specified"
            else
              # Validate category
              VALID_CATEGORIES="networking|web|graphics|game-engine|database|embedded|cli|gui|runtime|development-tools|testing|compiler|science|machine-learning|security|audio|video|compression|serialization|math|os|data-structures|memory|concurrency|other"
              if [[ "$CATEGORY" =~ ^($VALID_CATEGORIES)$ ]]; then
                echo "  âœ… category: $CATEGORY"
              else
                echo "  âš ï¸ category: '$CATEGORY' might not be a standard category"
                WARNINGS=$((WARNINGS + 1))
              fi
            fi
            
            if [ -z "$HOMEPAGE" ]; then
              echo "  â„¹ï¸ homepage: Not specified"
            else
              echo "  âœ… homepage: $HOMEPAGE"
            fi
            
            # Check GitHub repository exists
            if [ -n "$OWNER" ] && [ -n "$REPO" ]; then
              echo ""
              echo "ðŸŒ Checking GitHub repository: $OWNER/$REPO"
              
              HTTP_CODE=$(curl -s -o /tmp/repo_response.json -w "%{http_code}" \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/$OWNER/$REPO")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "  âœ… Repository exists"
                
                # Check if repo is archived
                IS_ARCHIVED=$(jq -r '.archived' /tmp/repo_response.json)
                if [ "$IS_ARCHIVED" = "true" ]; then
                  echo "  âš ï¸ Repository is archived"
                  WARNINGS=$((WARNINGS + 1))
                fi
                
                # Check if repo is a fork
                IS_FORK=$(jq -r '.fork' /tmp/repo_response.json)
                if [ "$IS_FORK" = "true" ]; then
                  echo "  âš ï¸ Repository is a fork"
                  WARNINGS=$((WARNINGS + 1))
                fi
                
                # Get repo language
                LANGUAGE=$(jq -r '.language // "Unknown"' /tmp/repo_response.json)
                echo "  ðŸ“ Primary language: $LANGUAGE"
                
                # Get repo license from GitHub
                GITHUB_LICENSE=$(jq -r '.license.spdx_id // "None"' /tmp/repo_response.json)
                echo "  ðŸ“œ GitHub license: $GITHUB_LICENSE"
                
                # Check last update
                UPDATED_AT=$(jq -r '.updated_at' /tmp/repo_response.json)
                echo "  ðŸ“… Last updated: $UPDATED_AT"
                
                # Check for releases
                echo ""
                echo "ðŸ“¦ Checking releases..."
                
                RELEASES_CODE=$(curl -s -o /tmp/releases_response.json -w "%{http_code}" \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "https://api.github.com/repos/$OWNER/$REPO/releases?per_page=5")
                
                if [ "$RELEASES_CODE" = "200" ]; then
                  RELEASE_COUNT=$(jq 'length' /tmp/releases_response.json)
                  if [ "$RELEASE_COUNT" -gt 0 ]; then
                    LATEST_RELEASE=$(jq -r '.[0].tag_name' /tmp/releases_response.json)
                    echo "  âœ… Found $RELEASE_COUNT release(s), latest: $LATEST_RELEASE"
                    
                    # Check for release assets
                    ASSET_COUNT=$(jq -r '.[0].assets | length' /tmp/releases_response.json)
                    if [ "$ASSET_COUNT" -gt 0 ]; then
                      echo "  ðŸ“Ž Latest release has $ASSET_COUNT asset(s)"
                    fi
                  else
                    echo "  â„¹ï¸ No releases found (will use main branch)"
                  fi
                fi
                
                # Check for build.zig or build.zig.zon
                echo ""
                echo "ðŸ”§ Checking for Zig build files..."
                
                BUILD_ZIG_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  "https://api.github.com/repos/$OWNER/$REPO/contents/build.zig")
                
                BUILD_ZON_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  "https://api.github.com/repos/$OWNER/$REPO/contents/build.zig.zon")
                
                if [ "$BUILD_ZIG_CODE" = "200" ]; then
                  echo "  âœ… build.zig found"
                else
                  echo "  âš ï¸ build.zig not found"
                  WARNINGS=$((WARNINGS + 1))
                fi
                
                if [ "$BUILD_ZON_CODE" = "200" ]; then
                  echo "  âœ… build.zig.zon found"
                else
                  echo "  â„¹ï¸ build.zig.zon not found"
                fi
                
              elif [ "$HTTP_CODE" = "404" ]; then
                echo "  âŒ Repository not found: https://github.com/$OWNER/$REPO"
                ERRORS=$((ERRORS + 1))
              elif [ "$HTTP_CODE" = "403" ]; then
                echo "  âš ï¸ Rate limited or access denied, skipping repo check"
                WARNINGS=$((WARNINGS + 1))
              else
                echo "  âš ï¸ Unexpected HTTP status: $HTTP_CODE"
                WARNINGS=$((WARNINGS + 1))
              fi
            fi
            
            echo ""
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Validation Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âŒ Errors: $ERRORS"
          echo "  âš ï¸ Warnings: $WARNINGS"
          echo ""
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Validation failed with $ERRORS error(s)"
            exit 1
          fi
          
          if [ $WARNINGS -gt 0 ]; then
            echo "::warning::Validation completed with $WARNINGS warning(s)"
          fi
          
          echo "âœ… Validation passed!"

  check-duplicates:
    name: Check for Duplicates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for duplicate repos
        run: |
          echo "ðŸ” Checking for duplicate repository entries..."
          
          DUPLICATES=0
          
          # Get all owner/repo combinations
          find repositories -name "*.json" -exec jq -r '"\(.owner)/\(.repo)"' {} \; | sort | uniq -d > /tmp/duplicates.txt
          
          if [ -s /tmp/duplicates.txt ]; then
            echo "âŒ Found duplicate repository entries:"
            cat /tmp/duplicates.txt
            DUPLICATES=1
          else
            echo "âœ… No duplicate repository entries found"
          fi
          
          # Check for duplicate names
          find repositories -name "*.json" -exec jq -r '.name' {} \; | sort | uniq -di > /tmp/name_duplicates.txt
          
          if [ -s /tmp/name_duplicates.txt ]; then
            echo ""
            echo "âš ï¸ Found entries with similar names (case-insensitive):"
            cat /tmp/name_duplicates.txt
          fi
          
          if [ $DUPLICATES -gt 0 ]; then
            exit 1
          fi

  lint-filenames:
    name: Lint Filenames
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            repositories/**/*.json

      - name: Validate filenames
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ” Validating filenames..."
          
          ERRORS=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            FILENAME=$(basename "$file")
            
            # Check lowercase
            if [[ "$FILENAME" =~ [A-Z] ]]; then
              echo "âŒ Filename should be lowercase: $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Check no spaces
            if [[ "$FILENAME" =~ \  ]]; then
              echo "âŒ Filename should not contain spaces: $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Check valid characters (alphanumeric, hyphens, underscores)
            if [[ ! "$FILENAME" =~ ^[a-z0-9_-]+\.json$ ]]; then
              echo "âŒ Filename should only contain lowercase letters, numbers, hyphens, and underscores: $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS filename issue(s)"
            exit 1
          fi
          
          echo "âœ… All filenames are valid"

  summary:
    name: Create Summary and Comment
    runs-on: ubuntu-latest
    needs: [validate, check-duplicates, lint-filenames]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Create PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const validateResult = '${{ needs.validate.result }}';
            const duplicateResult = '${{ needs.check-duplicates.result }}';
            const filenameResult = '${{ needs.lint-filenames.result }}';
            
            const allPassed = validateResult === 'success' && 
                              duplicateResult === 'success' && 
                              filenameResult === 'success';
            
            const statusEmoji = allPassed ? 'âœ…' : 'âŒ';
            const statusText = allPassed ? 'All checks passed!' : 'Some checks failed';
            
            const body = [
              `## ${statusEmoji} Registry Validation Results`,
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| Schema Validation | ${validateResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |`,
              `| Duplicate Check | ${duplicateResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |`,
              `| Filename Lint | ${filenameResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |`,
              '',
              `**Status**: ${statusText}`,
              '',
              allPassed 
                ? 'ðŸŽ‰ Your submission looks good! A maintainer will review it shortly.'
                : 'âš ï¸ Please fix the issues above and push your changes.',
              '',
              '---',
              '*ðŸ¤– This is an automated message from the Zig Index validation bot.*'
            ].join('\n');
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.body?.includes('Registry Validation Results') && 
              c.body?.includes('automated message')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing validation comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new validation comment');
            }

      - name: Write Step Summary
        run: |
          echo "## ðŸ“‹ Registry Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate.result }}" = "success" ]; then
            echo "âœ… **Schema Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Schema Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.check-duplicates.result }}" = "success" ]; then
            echo "âœ… **Duplicate Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Duplicate Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint-filenames.result }}" = "success" ]; then
            echo "âœ… **Filename Lint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Filename Lint**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For guidelines on adding projects, see [CONTRIBUTING.md](../CONTRIBUTING.md)" >> $GITHUB_STEP_SUMMARY
