name: Auto Label PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'repositories/**/*.json'

jobs:
  label:
    name: Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git remote add upstream https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git || true
          git fetch upstream ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Get changed files
        id: changed-files
        run: |
          # Get the list of changed files between base and head
          CHANGED_FILES=$(git diff --name-only upstream/${{ github.event.pull_request.base.ref }}...HEAD -- 'repositories/**/*.json' | tr '\n' ' ')
          ADDED_FILES=$(git diff --name-only --diff-filter=A upstream/${{ github.event.pull_request.base.ref }}...HEAD -- 'repositories/**/*.json' | tr '\n' ' ')
          DELETED_FILES=$(git diff --name-only --diff-filter=D upstream/${{ github.event.pull_request.base.ref }}...HEAD -- 'repositories/**/*.json' | tr '\n' ' ')
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M upstream/${{ github.event.pull_request.base.ref }}...HEAD -- 'repositories/**/*.json' | tr '\n' ' ')
          
          echo "all_changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "added_files=$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "deleted_files=$DELETED_FILES" >> $GITHUB_OUTPUT
          echo "modified_files=$MODIFIED_FILES" >> $GITHUB_OUTPUT
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Changed files: $CHANGED_FILES"
          echo "Added files: $ADDED_FILES"
          echo "Deleted files: $DELETED_FILES"
          echo "Modified files: $MODIFIED_FILES"

      - name: Auto label based on changes
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              console.log('No PR number found, skipping labeling');
              return;
            }
            
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ').filter(f => f);
            const labels = new Set();
            
            console.log('Changed files:', changedFiles);
            
            // Determine labels based on file paths
            for (const file of changedFiles) {
              if (file.includes('repositories/packages/')) {
                labels.add('package');
              }
              if (file.includes('repositories/applications/')) {
                labels.add('application');
              }
            }
            
            // Check if files were added, modified, or deleted
            const addedFiles = `${{ steps.changed-files.outputs.added_files }}`.split(' ').filter(f => f);
            const deletedFiles = `${{ steps.changed-files.outputs.deleted_files }}`.split(' ').filter(f => f);
            const modifiedFiles = `${{ steps.changed-files.outputs.modified_files }}`.split(' ').filter(f => f);
            
            console.log('Added:', addedFiles);
            console.log('Deleted:', deletedFiles);
            console.log('Modified:', modifiedFiles);
            
            if (addedFiles.length > 0) {
              labels.add('new-entry');
            }
            if (deletedFiles.length > 0) {
              labels.add('removal');
            }
            if (modifiedFiles.length > 0) {
              labels.add('update');
            }
            
            // Add registry label to all
            labels.add('registry');
            
            // Apply labels
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: Array.from(labels)
                });
                console.log('Applied labels:', Array.from(labels));
              } catch (error) {
                console.log('Error applying labels:', error.message);
                // Labels might not exist, try to create them
                for (const label of labels) {
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label,
                      color: label === 'new-entry' ? '0e8a16' : 
                             label === 'removal' ? 'b60205' :
                             label === 'update' ? 'fbca04' :
                             label === 'package' ? '1d76db' :
                             label === 'application' ? '5319e7' :
                             '7057ff'
                    });
                  } catch (e) {
                    // Label might already exist
                  }
                }
                // Retry adding labels
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: Array.from(labels)
                });
              }
            }

      - name: Comment on new entry PRs
        if: contains(steps.changed-files.outputs.added_files, '.json')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }
            
            const body = [
              '## ðŸŽ‰ Thanks for contributing to Zig Index!',
              '',
              'Your PR to add a new entry to the registry is being reviewed.',
              '',
              '### ðŸ“‹ Checklist',
              '',
              'Please ensure your submission meets our guidelines:',
              '',
              '- [ ] Project is open source and hosted on GitHub',
              '- [ ] Project uses Zig (has `build.zig` or `build.zig.zon`)',
              '- [ ] JSON file follows the schema (name, owner, repo, description are required)',
              '- [ ] Description is under 200 characters',
              '- [ ] Filename is lowercase with hyphens (e.g., `my-package.json`)',
              '- [ ] Project is actively maintained (updated in the last year)',
              '',
              '### ðŸ¤– Automated Checks',
              '',
              'The validation workflow will verify:',
              '- âœ… JSON syntax is valid',
              '- âœ… Required fields are present',
              '- âœ… GitHub repository exists and is accessible',
              '- âœ… No duplicate entries in the registry',
              '- âœ… Filename follows conventions',
              '',
              '---',
              '',
              'Thank you for helping grow the Zig ecosystem! ðŸš€'
            ].join('\n');
            
            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.data.find(c => 
              c.body?.includes('Thanks for contributing to Zig Index') &&
              c.body?.includes('automated message')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body + '\n\n---\n*ðŸ¤– This is an automated message from the Zig Index bot.*'
              });
              console.log('Added welcome comment to PR #' + prNumber);
            } else {
              console.log('Welcome comment already exists on PR #' + prNumber);
            }

      - name: Comment on removal PRs
        if: contains(steps.changed-files.outputs.deleted_files, '.json')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) return;
            
            const deletedFiles = `${{ steps.changed-files.outputs.deleted_files }}`.split(' ').filter(f => f);
            const fileList = deletedFiles.map(f => '- `' + f + '`').join('\n');
            
            const body = [
              '## ðŸ—‘ï¸ Removal Request',
              '',
              'This PR removes the following entries from the registry:',
              '',
              fileList,
              '',
              '### âš ï¸ Please confirm:',
              '',
              '- [ ] The project is no longer maintained/available',
              '- [ ] Or the project owner requested removal',
              '- [ ] Or there is a valid reason for removal (please explain in PR description)',
              '',
              'A maintainer will review this removal request.'
            ].join('\n');
            
            // Check if we already commented about removal
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const removalComment = comments.data.find(c => 
              c.body?.includes('Removal Request') &&
              c.body?.includes('automated message')
            );
            
            if (!removalComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body + '\n\n---\n*ðŸ¤– This is an automated message from the Zig Index bot.*'
              });
            }
