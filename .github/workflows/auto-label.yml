name: Auto Label PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
    paths:
      - 'repositories/**/*.json'
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'repositories/**/*.json'

jobs:
  label:
    name: Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            repositories/**/*.json

      - name: Auto label based on changes
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              console.log('No PR number found, skipping labeling');
              return;
            }
            
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ').filter(f => f);
            const labels = new Set();
            
            console.log('Changed files:', changedFiles);
            
            // Determine labels based on file paths
            for (const file of changedFiles) {
              if (file.includes('repositories/packages/')) {
                labels.add('package');
              }
              if (file.includes('repositories/applications/')) {
                labels.add('application');
              }
            }
            
            // Check if files were added, modified, or deleted
            const addedFiles = `${{ steps.changed-files.outputs.added_files }}`.split(' ').filter(f => f);
            const deletedFiles = `${{ steps.changed-files.outputs.deleted_files }}`.split(' ').filter(f => f);
            const modifiedFiles = `${{ steps.changed-files.outputs.modified_files }}`.split(' ').filter(f => f);
            
            console.log('Added:', addedFiles);
            console.log('Deleted:', deletedFiles);
            console.log('Modified:', modifiedFiles);
            
            if (addedFiles.length > 0) {
              labels.add('new-entry');
            }
            if (deletedFiles.length > 0) {
              labels.add('removal');
            }
            if (modifiedFiles.length > 0) {
              labels.add('update');
            }
            
            // Add registry label to all
            labels.add('registry');
            
            // Apply labels
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: Array.from(labels)
                });
                console.log('Applied labels:', Array.from(labels));
              } catch (error) {
                console.log('Error applying labels:', error.message);
                // Labels might not exist, try to create them
                for (const label of labels) {
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label,
                      color: label === 'new-entry' ? '0e8a16' : 
                             label === 'removal' ? 'b60205' :
                             label === 'update' ? 'fbca04' :
                             label === 'package' ? '1d76db' :
                             label === 'application' ? '5319e7' :
                             '7057ff'
                    });
                  } catch (e) {
                    // Label might already exist
                  }
                }
                // Retry adding labels
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: Array.from(labels)
                });
              }
            }

      - name: Comment on new entry PRs
        if: contains(steps.changed-files.outputs.added_files, '.json')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }
            
            const body = [
              '## ðŸŽ‰ Thanks for contributing to Zig Index!',
              '',
              'Your PR to add a new entry to the registry is being reviewed.',
              '',
              '### ðŸ“‹ Checklist',
              '',
              'Please ensure your submission meets our guidelines:',
              '',
              '- [ ] Project is open source and hosted on GitHub',
              '- [ ] Project uses Zig (has `build.zig` or `build.zig.zon`)',
              '- [ ] JSON file follows the schema (name, owner, repo, description are required)',
              '- [ ] Description is under 200 characters',
              '- [ ] Filename is lowercase with hyphens (e.g., `my-package.json`)',
              '- [ ] Project is actively maintained (updated in the last year)',
              '',
              '### ðŸ¤– Automated Checks',
              '',
              'The validation workflow will verify:',
              '- âœ… JSON syntax is valid',
              '- âœ… Required fields are present',
              '- âœ… GitHub repository exists and is accessible',
              '- âœ… No duplicate entries in the registry',
              '- âœ… Filename follows conventions',
              '',
              '### ðŸ“ Entry Details',
              '',
              'Please confirm the following details are correct in your JSON file:',
              '',
              '| Field | Required | Description |',
              '|-------|----------|-------------|',
              '| `name` | âœ… | Display name of your project |',
              '| `owner` | âœ… | GitHub username or organization |',
              '| `repo` | âœ… | Repository name |',
              '| `description` | âœ… | Brief description (max 200 chars) |',
              '| `category` | âŒ | Category for filtering |',
              '| `license` | âŒ | SPDX license identifier |',
              '| `homepage` | âŒ | Project website URL |',
              '',
              '---',
              '',
              'Thank you for helping grow the Zig ecosystem! ðŸš€'
            ].join('\n');
            
            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.data.find(c => 
              c.body?.includes('Thanks for contributing to Zig Index') &&
              c.body?.includes('automated message')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body + '\n\n---\n*ðŸ¤– This is an automated message from the Zig Index bot.*'
              });
              console.log('Added welcome comment to PR #' + prNumber);
            } else {
              console.log('Welcome comment already exists on PR #' + prNumber);
            }

      - name: Comment on removal PRs
        if: contains(steps.changed-files.outputs.deleted_files, '.json')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) return;
            
            const deletedFiles = `${{ steps.changed-files.outputs.deleted_files }}`.split(' ').filter(f => f);
            const fileList = deletedFiles.map(f => '- `' + f + '`').join('\n');
            
            const body = [
              '## ðŸ—‘ï¸ Removal Request',
              '',
              'This PR removes the following entries from the registry:',
              '',
              fileList,
              '',
              '### âš ï¸ Please confirm:',
              '',
              '- [ ] The project is no longer maintained/available',
              '- [ ] Or the project owner requested removal',
              '- [ ] Or there is a valid reason for removal (please explain in PR description)',
              '',
              'A maintainer will review this removal request.'
            ].join('\n');
            
            // Check if we already commented about removal
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const removalComment = comments.data.find(c => 
              c.body?.includes('Removal Request') &&
              c.body?.includes('automated message')
            );
            
            if (!removalComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body + '\n\n---\n*ðŸ¤– This is an automated message from the Zig Index bot.*'
              });
            }
